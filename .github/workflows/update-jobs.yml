name: Update Job Listings

on:
  schedule:
    # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡: 0:00, 6:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      # ä»…åœ¨è„šæœ¬æˆ– workflow å˜æ›´æ—¶è§¦å‘
      - 'scripts/update_readme.py'
      - '.github/workflows/update-jobs.yml'

jobs:
  update-jobs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Enable pip caching

      - name: Cache system dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /var/cache/apt/archives
          key: ${{ runner.os }}-deps-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run update script
        id: update
        run: |
          echo "Starting job update..."
          python scripts/update_readme.py 2>&1 | tee update.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -ne 0 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit $EXIT_CODE
          fi
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Verify generated files
        if: steps.update.outputs.status == 'success'
        run: |
          echo "Verifying generated files..."

          # Check files exist
          for file in README.md public/index.html public/stats.json sitemap.xml public/sitemap.xml public/og-image.png; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing file: $file"
              exit 1
            fi
            echo "âœ“ $file exists"
          done

          # Validate stats.json
          python3 -c "import json; data=json.load(open('public/stats.json')); print(f'Jobs: {data[\"total_jobs\"]}, Companies: {data[\"total_companies\"]}')"

          # Check minimum job count
          JOBS_COUNT=$(python3 -c "import json; print(json.load(open('public/stats.json'))['total_jobs'])")
          if [ "$JOBS_COUNT" -lt 100 ]; then
            echo "WARNING: Only $JOBS_COUNT jobs found (expected >= 100)"
          fi

          echo "âœ“ All validations passed"

      - name: Extract stats for commit message
        if: steps.update.outputs.status == 'success'
        id: stats
        run: |
          JOBS=$(python3 -c "import json; print(json.load(open('public/stats.json'))['total_jobs'])")
          COMPANIES=$(python3 -c "import json; print(json.load(open('public/stats.json'))['total_companies'])")
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

          echo "jobs=$JOBS" >> $GITHUB_OUTPUT
          echo "companies=$COMPANIES" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.update.outputs.status == 'success'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md public/ sitemap.xml

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Pull with rebase to avoid conflicts
          echo "Pulling latest changes to avoid conflicts..."
          git pull --rebase --autostash

          git commit -m "Update job listings [${{ steps.stats.outputs.timestamp }}]

          - Total jobs: ${{ steps.stats.outputs.jobs }}
          - Total companies: ${{ steps.stats.outputs.companies }}

          ðŸ¤– Auto-generated by GitHub Actions"

          # Push with retry on failure
          MAX_RETRIES=3
          RETRY_COUNT=0
          until git push || [ $RETRY_COUNT -ge $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT+1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Push failed (attempt $RETRY_COUNT/$MAX_RETRIES). Retrying..."
              sleep 5
              # Pull again before retry
              git pull --rebase --autostash
            fi
          done

          if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
            echo "ERROR: Failed to push after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: update-logs-${{ github.run_number }}
          path: update.log
          retention-days: 7

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let logContent = '';
            try {
              logContent = fs.readFileSync('update.log', 'utf8').slice(-2000);
            } catch (e) {
              logContent = 'Could not read log file';
            }

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'bot:update-failed'
            });

            // Don't create duplicate issues
            if (issues.data.length > 0) {
              console.log('Open failure issue already exists, skipping creation');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Job update failed',
              labels: ['bot:update-failed', 'bug'],
              body: `## Job Update Failed

            The scheduled job update workflow failed at ${new Date().toISOString()}.

            **Workflow run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Last 2000 characters of log:
            \`\`\`
            ${logContent}
            \`\`\`

            Please investigate and fix the issue.

            ---
            *This issue was auto-created by GitHub Actions*`
            });
